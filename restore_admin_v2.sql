UPDATE workflow_entity SET nodes='[{"parameters": {"httpMethod": "POST", "path": "kreativ-unified-api", "responseMode": "responseNode", "options": {}, "webhookId": "kreativ-unified-api-id"}, "name": "Webhook API", "type": "n8n-nodes-base.webhook", "typeVersion": 2, "id": "node-webhook"}, {"parameters": {"jsCode": "const body = .body || ;\nconst phone = String(body.phone || \"\").replace(/\\D/g, \"\");\nconst action = body.action || \"check_student\";\nreturn [{ json: { ...body, phone, action } }];"}, "name": "Normalizar", "type": "n8n-nodes-base.code", "typeVersion": 2, "id": "node-norm"}, {"parameters": {"rules": {"values": [{"conditions": {"conditions": [{"leftValue": "={{ .action }}", "rightValue": "check_student"}]}}, {"conditions": {"conditions": [{"leftValue": "={{ .action }}", "rightValue": "request_human"}]}}, {"conditions": {"conditions": [{"leftValue": "={{ .action }}", "rightValue": "get_module"}]}}, {"conditions": {"conditions": [{"leftValue": "={{ .action }}", "rightValue": "get_progress"}]}}, {"conditions": {"conditions": [{"leftValue": "={{ .action }}", "rightValue": "submit_quiz"}]}}, {"conditions": {"conditions": [{"leftValue": "={{ .action }}", "rightValue": "ai_tutor"}]}}, {"conditions": {"conditions": [{"leftValue": "={{ .action }}", "rightValue": "admin_upsert_course"}]}}, {"conditions": {"conditions": [{"leftValue": "={{ .action }}", "rightValue": "admin_upsert_module"}]}}]}}, "name": "Switch", "type": "n8n-nodes-base.switch", "typeVersion": 3, "id": "node-switch"}, {"parameters": {"method": "POST", "url": "https://n8n.extensionista.site/webhook/kreativ-ai-tutor-v3", "sendBody": true, "specifyBody": "json", "jsonBody": "={{ { phone: .phone, body: .message || .body } }}"}, "name": "Proxy Tutor", "type": "n8n-nodes-base.httpRequest", "typeVersion": 4.2, "id": "node-proxy"}, {"parameters": {"operation": "executeQuery", "query": "INSERT INTO courses (id, name, slug, area, is_active) VALUES ((SELECT COALESCE(MAX(id), 0) + 1 FROM courses), ''{{ .name }}'', ''{{ .name.toLowerCase().replace(/ /g, \"-\") }}'', ''{{ .area || \"geral\" }}'', true) ON CONFLICT (slug) DO UPDATE SET name = EXCLUDED.name, updated_at = NOW() RETURNING id, name;", "options": {}}, "name": "DB: Upsert Course", "type": "n8n-nodes-base.postgres", "typeVersion": 2.6, "id": "node-db-course", "credentials": {"postgres": {"id": "lJaeEy4CpHbhgMAp", "name": "Kreativ PostgreSQL"}}}, {"parameters": {"operation": "executeQuery", "query": "INSERT INTO modules (course_int_id, course_id, module_number, title, content_text, is_published, is_active) VALUES ({{ .course_id }}, ''{{ .course_id }}'', {{ .module_number }}, ''{{ .title }}'', ''{{ (.content || \"\") | replace(\"''\", \"''''\") }}'', true, true) ON CONFLICT (course_id, module_number) DO UPDATE SET title = EXCLUDED.title, content_text = EXCLUDED.content_text, updated_at = NOW() RETURNING id;", "options": {}}, "name": "DB: Upsert Module", "type": "n8n-nodes-base.postgres", "typeVersion": 2.6, "id": "node-db-module", "credentials": {"postgres": {"id": "lJaeEy4CpHbhgMAp", "name": "Kreativ PostgreSQL"}}}, {"parameters": {"respondWith": "json", "responseBody": "={{ JSON.stringify() }}"}, "name": "Responder", "type": "n8n-nodes-base.respondToWebhook", "typeVersion": 1, "id": "node-resp"}]', connections='{"Webhook API": {"main": [[{"node": "Normalizar", "type": "main", "index": 0}]]}, "Normalizar": {"main": [[{"node": "Switch", "type": "main", "index": 0}]]}, "Switch": {"main": [[], [], [], [], [], [{"node": "Proxy Tutor", "type": "main", "index": 0}], [{"node": "DB: Upsert Course", "type": "main", "index": 0}], [{"node": "DB: Upsert Module", "type": "main", "index": 0}]]}, "Proxy Tutor": {"main": [[{"node": "Responder", "type": "main", "index": 0}]]}, "DB: Upsert Course": {"main": [[{"node": "Responder", "type": "main", "index": 0}]]}, "DB: Upsert Module": {"main": [[{"node": "Responder", "type": "main", "index": 0}]]}}', name='Kreativ: Unified API Router (v1.2 - Admin Restored)' WHERE id='Zvxg60A5YWDcq28I';
