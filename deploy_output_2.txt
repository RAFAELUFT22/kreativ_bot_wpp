Found existing workflow: pDnDwl6D7mFdYSRf
Update Status: 200 {"updatedAt":"2026-02-19T13:03:26.115Z","createdAt":"2026-02-19T11:49:04.247Z","id":"pDnDwl6D7mFdYSRf","name":"Kreativ: AI Cognitive Router","description":null,"active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"ai-router","responseMode":"onReceived","options":{}},"id":"webhook-start","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[260,340],"webhookId":"kreativ-ai-router"},{"parameters":{"conditions":{"string":[{"value1":"={{ $json.body.body }}","operation":"contains","value2":"humano"},{"value1":"={{ $json.body.body }}","operation":"contains","value2":"suporte"},{"value1":"={{ $json.body.body }}","operation":"contains","value2":"atendente"}]},"combinator":"or"},"id":"if-regex","name":"Check Keywords","type":"n8n-nodes-base.if","typeVersion":1,"position":[480,340]},{"parameters":{"conditions":{"string":[{"value1":"={{ $env[\"ACTIVE_LLM_PROVIDER\"] }}","value2":"openrouter"}]}},"id":"if-provider","name":"If OpenRouter","type":"n8n-nodes-base.if","typeVersion":1,"position":[480,540]},{"parameters":{"method":"POST","url":"https://api.deepseek.com/chat/completions","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Bearer sk-412552782fbe4009a25a013825e6ab66"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ model: 'deepseek-chat', messages: [{ role: 'system', content: 'You are Kreativ educational tutor. Always respond in JSON format: { \"action\": \"reply\"|\"handover\", \"text\": \"...\" }. If user asks for human/support, set action=\"handover\". Keep text short.' }, { role: 'user', content: $('Webhook').first().json.body.body }] }) }}"},"id":"deepseek-api","name":"DeepSeek API","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[700,440]},{"parameters":{"method":"POST","url":"https://openrouter.ai/api/v1/chat/completions","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"={{ 'Bearer ' + $env[\"OPEN_ROUTER_API\"] }}"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ model: 'deepseek/deepseek-chat', messages: [{ role: 'system', content: 'You are Kreativ educational tutor. Always respond in JSON format: { \"action\": \"reply\"|\"handover\", \"text\": \"...\" }. If user asks for human/support, set action=\"handover\". Keep text short.' }, { role: 'user', content: $('Webhook').first().json.body.body }] }) }}"},"id":"openrouter-api","name":"OpenRouter API","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[700,640]},{"parameters":{"jsCode":"const response = $input.item.json.choices[0].message.content;\nlet parsed;\ntry {\n  const clean = response.replace(/```json/g, '').replace(/```/g, '').trim();\n  parsed = JSON.parse(clean);\n} catch (e) {\n  parsed = { action: 'reply', text: response };\n}\nreturn [{ json: { ...parsed, original_phone: $('Webhook').first().json.body.phone } }];"},"id":"parse-llm","name":"Parse LLM Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[920,540]},{"parameters":{"conditions":{"string":[{"value1":"={{ $json.action }}","value2":"handover"}]}},"id":"if-handover","name":"If Handover","type":"n8n-nodes-base.if","typeVersion":1,"position":[1140,540]},{"parameters":{"method":"POST","url":"http://kreativ_builderbot:3008/api/send","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ phone: $json.original_phone, message: $json.text }) }}"},"id":"callback-bot","name":"Callback BuilderBot","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[1400,440]},{"parameters":{"method":"POST","url":"http://kreativ_n8n:5678/webhook/request-human-support","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ phone: $('Webhook').first().json.body.phone, reason: 'Solicitado via IA (Regex/LLM)' }) }}"},"onError":"continueErrorOutput","id":"trigger-handoff","name":"Trigger Handoff","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[1400,640]},{"parameters":{"jsCode":"console.log('HANDOFF COMPLETE for ' + $('Webhook').first().json.body.phone);\nreturn $input.all();"},"id":"log-success","name":"Log Success","type":"n8n-nodes-base.code","typeVersion":2,"position":[1600,640]},{"parameters":{"method":"POST","url":"http://kreativ_builderbot:3008/api/send","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ phone: $('Webhook').first().json.body.phone, message: $json.text || 'Entendido. Transferindo para um humano...' }) }}"},"id":"notify-handoff","name":"Notify User Handoff","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[1800,640]}],"connections":{"Webhook":{"main":[[{"node":"Check Keywords","type":"main","index":0}]]},"Check Keywords":{"main":[[{"node":"Trigger Handoff","type":"main","index":0}],[{"node":"If OpenRouter","type":"main","index":0}]]},"If OpenRouter":{"main":[[{"node":"OpenRouter API","type":"main","index":0}],[{"node":"DeepSeek API","type":"main","index":0}]]},"DeepSeek API":{"main":[[{"node":"Parse LLM Response","type":"main","index":0}]]},"OpenRouter API":{"main":[[{"node":"Parse LLM Response","type":"main","index":0}]]},"Parse LLM Response":{"main":[[{"node":"If Handover","type":"main","index":0}]]},"If Handover":{"main":[[{"node":"Trigger Handoff","type":"main","index":0}],[{"node":"Callback BuilderBot","type":"main","index":0}]]},"Trigger Handoff":{"main":[[{"node":"Log Success","type":"main","index":0}]]},"Log Success":{"main":[[{"node":"Notify User Handoff","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":null,"meta":null,"pinData":null,"versionId":"c3d06ef7-bf09-462f-a1b9-fdb6d00d2007","activeVersionId":"c3d06ef7-bf09-462f-a1b9-fdb6d00d2007","versionCounter":42,"triggerCount":1,"tags":[],"activeVersion":{"updatedAt":"2026-02-19T12:56:34.126Z","createdAt":"2026-02-19T12:56:34.126Z","versionId":"c3d06ef7-bf09-462f-a1b9-fdb6d00d2007","workflowId":"pDnDwl6D7mFdYSRf","nodes":[{"parameters":{"httpMethod":"POST","path":"ai-router","responseMode":"onReceived","options":{}},"id":"webhook-start","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[260,340],"webhookId":"kreativ-ai-router"},{"parameters":{"conditions":{"string":[{"value1":"={{ $json.body.body }}","operation":"contains","value2":"humano"},{"value1":"={{ $json.body.body }}","operation":"contains","value2":"suporte"},{"value1":"={{ $json.body.body }}","operation":"contains","value2":"atendente"}]},"combinator":"or"},"id":"if-regex","name":"Check Keywords","type":"n8n-nodes-base.if","typeVersion":1,"position":[480,340]},{"parameters":{"conditions":{"string":[{"value1":"={{ $env[\"ACTIVE_LLM_PROVIDER\"] }}","value2":"openrouter"}]}},"id":"if-provider","name":"If OpenRouter","type":"n8n-nodes-base.if","typeVersion":1,"position":[480,540]},{"parameters":{"method":"POST","url":"https://api.deepseek.com/chat/completions","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Bearer sk-412552782fbe4009a25a013825e6ab66"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ model: 'deepseek-chat', messages: [{ role: 'system', content: 'You are Kreativ educational tutor. Always respond in JSON format: { \"action\": \"reply\"|\"handover\", \"text\": \"...\" }. If user asks for human/support, set action=\"handover\". Keep text short.' }, { role: 'user', content: $('Webhook').first().json.body.body }] }) }}"},"id":"deepseek-api","name":"DeepSeek API","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[700,440]},{"parameters":{"method":"POST","url":"https://openrouter.ai/api/v1/chat/completions","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"={{ 'Bearer ' + $env[\"OPEN_ROUTER_API\"] }}"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ model: 'deepseek/deepseek-chat', messages: [{ role: 'system', content: 'You are Kreativ educational tutor. Always respond in JSON format: { \"action\": \"reply\"|\"handover\", \"text\": \"...\" }. If user asks for human/support, set action=\"handover\". Keep text short.' }, { role: 'user', content: $('Webhook').first().json.body.body }] }) }}"},"id":"openrouter-api","name":"OpenRouter API","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[700,640]},{"parameters":{"jsCode":"const response = $input.item.json.choices[0].message.content;\nlet parsed;\ntry {\n  const clean = response.replace(/```json/g, '').replace(/```/g, '').trim();\n  parsed = JSON.parse(clean);\n} catch (e) {\n  parsed = { action: 'reply', text: response };\n}\nreturn [{ json: { ...parsed, original_phone: $('Webhook').first().json.body.phone } }];"},"id":"parse-llm","name":"Parse LLM Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[920,540]},{"parameters":{"conditions":{"string":[{"value1":"={{ $json.action }}","value2":"handover"}]}},"id":"if-handover","name":"If Handover","type":"n8n-nodes-base.if","typeVersion":1,"position":[1140,540]},{"parameters":{"method":"POST","url":"http://kreativ_builderbot:3008/api/send","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ phone: $json.original_phone, message: $json.text }) }}"},"id":"callback-bot","name":"Callback BuilderBot","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[1400,440]},{"parameters":{"method":"POST","url":"http://kreativ_n8n:5678/webhook/request-human-support","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ phone: $('Webhook').first().json.body.phone, reason: 'Solicitado via IA (Regex/LLM)' }) }}"},"onError":"continueErrorOutput","id":"trigger-handoff","name":"Trigger Handoff","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[1400,640]},{"parameters":{"jsCode":"console.log('HANDOFF COMPLETE for ' + $('Webhook').first().json.body.phone);\nreturn $input.all();"},"id":"log-success","name":"Log Success","type":"n8n-nodes-base.code","typeVersion":2,"position":[1600,640]},{"parameters":{"method":"POST","url":"http://kreativ_builderbot:3008/api/send","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ phone: $('Webhook').first().json.body.phone, message: $json.text || 'Entendido. Transferindo para um humano...' }) }}"},"id":"notify-handoff","name":"Notify User Handoff","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[1800,640]}],"connections":{"Webhook":{"main":[[{"node":"Check Keywords","type":"main","index":0}]]},"Check Keywords":{"main":[[{"node":"Trigger Handoff","type":"main","index":0}],[{"node":"If OpenRouter","type":"main","index":0}]]},"If OpenRouter":{"main":[[{"node":"OpenRouter API","type":"main","index":0}],[{"node":"DeepSeek API","type":"main","index":0}]]},"DeepSeek API":{"main":[[{"node":"Parse LLM Response","type":"main","index":0}]]},"OpenRouter API":{"main":[[{"node":"Parse LLM Response","type":"main","index":0}]]},"Parse LLM Response":{"main":[[{"node":"If Handover","type":"main","index":0}]]},"If Handover":{"main":[[{"node":"Trigger Handoff","type":"main","index":0}],[{"node":"Callback BuilderBot","type":"main","index":0}]]},"Trigger Handoff":{"main":[[{"node":"Log Success","type":"main","index":0}]]},"Log Success":{"main":[[{"node":"Notify User Handoff","type":"main","index":0}]]}},"authors":"Rafael da Silva","name":null,"description":null,"autosaved":false}}
